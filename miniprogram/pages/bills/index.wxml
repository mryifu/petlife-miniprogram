<!-- pages/bills/index.wxml -->
<view class="container">
  <!-- å® ç‰©ä¿¡æ¯å¡ç‰‡ -->
  <view class="pet-header-card" wx:if="{{pet}}">
    <image class="pet-avatar-mini" src="{{pet.avatar}}" mode="aspectFill"></image>
    <view class="pet-info-mini">
      <text class="pet-name-mini">{{pet.name}}</text>
      <text class="pet-species-mini">{{pet.species}}</text>
    </view>
  </view>

  <!-- æ±‡æ€»å¡ç‰‡ -->
  <view class="summary-card">
    <view class="summary-header">
      <text class="summary-title">æ€»æ¶ˆè´¹</text>
      <view class="add-btn-fab" bindtap="showAddBillSheet">
        <text class="fab-icon-small">+</text>
      </view>
    </view>
    <view class="summary-amount">
      <text class="currency">Â¥</text>
      <text class="amount-value">{{totalAmount}}</text>
    </view>
    <view class="summary-label">{{timeFilter === 'today' ? 'ä»Šå¤©' : timeFilter === 'week' ? 'æœ¬å‘¨' : timeFilter === 'month' ? 'æœ¬æœˆ' : timeFilter === 'year' ? 'ä»Šå¹´' : 'å…¨éƒ¨'}}çš„æ¶ˆè´¹</view>
  </view>

  <!-- æ—¶é—´ç­›é€‰ -->
  <scroll-view class="time-filters" scroll-x>
    <view class="filter-tabs">
      <view class="filter-tab {{timeFilter === 'today' ? 'active' : ''}}" bindtap="onTimeFilterChange" data-filter="today">
        <text>ä»Šå¤©</text>
      </view>
      <view class="filter-tab {{timeFilter === 'week' ? 'active' : ''}}" bindtap="onTimeFilterChange" data-filter="week">
        <text>æœ¬å‘¨</text>
      </view>
      <view class="filter-tab {{timeFilter === 'month' ? 'active' : ''}}" bindtap="onTimeFilterChange" data-filter="month">
        <text>æœ¬æœˆ</text>
      </view>
      <view class="filter-tab {{timeFilter === 'year' ? 'active' : ''}}" bindtap="onTimeFilterChange" data-filter="year">
        <text>ä»Šå¹´</text>
      </view>
      <view class="filter-tab {{timeFilter === 'all' ? 'active' : ''}}" bindtap="onTimeFilterChange" data-filter="all">
        <text>å…¨éƒ¨</text>
      </view>
    </view>
  </scroll-view>

  <!-- åˆ†ç±»ç»Ÿè®¡ -->
  <view class="category-stats" wx:if="{{categoryStats.length > 0}}">
    <view class="stats-title">åˆ†ç±»ç»Ÿè®¡</view>
    <view class="stats-list">
      <block wx:for="{{categoryStats}}" wx:key="id">
        <view class="stat-item" bindtap="onCategoryFilterChange" data-id="{{item.id}}">
          <view class="stat-icon" style="background: {{item.color}}20;">
            <text style="color: {{item.color}};">{{item.emoji}}</text>
          </view>
          <view class="stat-info">
            <text class="stat-name">{{item.name}}</text>
            <text class="stat-percent">{{item.percent}}%</text>
          </view>
          <text class="stat-amount">Â¥{{item.amountStr}}</text>
        </view>
      </block>
    </view>
  </view>

  <!-- åˆ†ç±»ç­›é€‰ -->
  <scroll-view class="category-filters" scroll-x>
    <view class="filter-tabs">
      <view class="filter-tab {{categoryFilter === 'all' ? 'active' : ''}}" bindtap="onCategoryFilterChange" data-id="all">
        <text>å…¨éƒ¨</text>
      </view>
      <block wx:for="{{categories}}" wx:key="id">
        <view class="filter-tab {{categoryFilter === item.id ? 'active' : ''}}" bindtap="onCategoryFilterChange" data-id="{{item.id}}" style="border-color: {{item.color}}; color: {{categoryFilter === item.id ? item.color : '#8D7B68'}};">
          <text class="tab-emoji">{{item.emoji}}</text>
          <text>{{item.name}}</text>
        </view>
      </block>
    </view>
  </scroll-view>

  <!-- æ¶ˆè´¹è®°å½•åˆ—è¡¨ -->
  <view class="records-section">
    <view class="section-header">
      <text class="section-title">æ¶ˆè´¹æ˜ç»†</text>
      <text class="section-count">å…±{{filteredBills.length}}æ¡</text>
    </view>

    <view class="empty-state" wx:if="{{filteredBills.length === 0}}">
      <text class="empty-icon">ğŸ’°</text>
      <text class="empty-text">è¿˜æ²¡æœ‰æ¶ˆè´¹è®°å½•</text>
      <text class="empty-hint">ç‚¹å‡»å³ä¸Šè§’æ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§</text>
    </view>

    <view class="records-list" wx:else>
      <block wx:for="{{filteredBills}}" wx:key="_id">
        <view class="bill-item" bindlongpress="deleteBill" data-id="{{item._id}}">
          <view class="bill-icon" style="background: {{item.categoryInfo.color}}20;">
            <text style="color: {{item.categoryInfo.color}};">
              {{item.categoryInfo.emoji}}
            </text>
          </view>
          <view class="bill-content">
            <view class="bill-header">
              <text class="bill-category">{{item.categoryInfo.name}}</text>
              <text class="bill-sub" wx:if="{{item.subCategory}}">Â· {{item.subCategory}}</text>
            </view>
            <text class="bill-date">{{item.date}}</text>
            <text class="bill-note" wx:if="{{item.note}}">{{item.note}}</text>
          </view>
          <view class="bill-amount">
            <text class="amount-symbol">Â¥</text>
            <text class="amount-number">{{item.amountStr}}</text>
          </view>
        </view>
      </block>
    </view>
  </view>
</view>

<!-- æ·»åŠ æ¶ˆè´¹å¼¹çª— -->
<view class="modal {{showAddSheet ? 'show' : ''}}" bindtap="closeAddSheet">
  <view class="modal-content bill-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">æ·»åŠ æ¶ˆè´¹è®°å½•</text>
      <text class="modal-close" bindtap="closeAddSheet">âœ•</text>
    </view>

    <view class="modal-body">
      <view class="form-group">
        <text class="label">é‡‘é¢ (å…ƒ)</text>
        <input class="input large-input" type="digit" placeholder="0.00" value="{{newBill.amount}}" bindinput="onAmountInput" />
      </view>

      <view class="form-group">
        <text class="label">åˆ†ç±»</text>
        <picker mode="selector" range="{{categories}}" range-key="name" value="{{categoryIndex}}" bindchange="onCategoryChange">
          <view class="picker">
            <text class="picker-emoji">{{categories[categoryIndex].emoji}}</text>
            <text>{{categories[categoryIndex].name}}</text>
          </view>
        </picker>
      </view>

      <view class="form-group">
        <text class="label">å­åˆ†ç±»</text>
        <input class="input" placeholder="ä¾‹å¦‚ï¼šä¸»ç²®ã€é›¶é£Ÿç­‰" value="{{newBill.subCategory}}" bindinput="onSubCategoryChange" />
      </view>

      <view class="form-group">
        <text class="label">æ—¥æœŸ</text>
        <picker mode="date" value="{{newBill.date}}" bindchange="onDateChange">
          <view class="picker">{{newBill.date}}</view>
        </picker>
      </view>

      <view class="form-group">
        <text class="label">å¤‡æ³¨</text>
        <textarea class="textarea" placeholder="è®°å½•ä¸€äº›ç»†èŠ‚..." value="{{newBill.note}}" bindinput="onNoteInput" maxlength="100"></textarea>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn-primary" bindtap="saveBill">ä¿å­˜è®°å½•</button>
    </view>
  </view>
</view>
