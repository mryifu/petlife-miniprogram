<!-- pages/weight/index.wxml -->
<view class="container">
  <!-- å® ç‰©ä¿¡æ¯å¡ç‰‡ -->
  <view class="pet-header-card" wx:if="{{pet}}">
    <image class="pet-avatar-mini" src="{{pet.avatar}}" mode="aspectFill"></image>
    <view class="pet-info-mini">
      <text class="pet-name-mini">{{pet.name}}</text>
      <text class="pet-species-mini">{{pet.species}}</text>
    </view>
  </view>

  <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
  <view class="stats-grid">
    <!-- å½“å‰ä½“é‡ -->
    <view class="stat-card current">
      <view class="stat-icon">âš–ï¸</view>
      <view class="stat-value">{{currentWeight}}kg</view>
      <view class="stat-label">å½“å‰ä½“é‡</view>
    </view>

    <!-- ç›®æ ‡ä½“é‡ -->
    <view class="stat-card target" bindtap="showTargetWeightSheet">
      <view class="stat-icon">ğŸ¯</view>
      <view class="stat-value">{{targetWeight || '--'}}kg</view>
      <view class="stat-label">ç›®æ ‡ä½“é‡</view>
      <view class="stat-action">ç‚¹å‡»è®¾ç½®</view>
    </view>

    <!-- ä½“é‡å˜åŒ– -->
    <view class="stat-card change {{weightChange > 0 ? 'up' : weightChange < 0 ? 'down' : ''}}">
      <view class="stat-icon">{{weightChange > 0 ? 'ğŸ“ˆ' : weightChange < 0 ? 'ğŸ“‰' : 'â–'}}</view>
      <view class="stat-value">{{weightChange > 0 ? '+' : ''}}{{weightChange}}kg</view>
      <view class="stat-label">è¾ƒä¸Šæ¬¡</view>
      <view class="stat-percent">{{weightChangePercent > 0 ? '+' : ''}}{{weightChangePercent}}%</view>
    </view>
  </view>

  <!-- ä½“é‡æŠ˜çº¿å›¾ -->
  <view class="chart-card" wx:if="{{weights.length > 0}}">
    <view class="card-title">
      <text class="title-text">ä½“é‡è¶‹åŠ¿</text>
      <text class="title-count">å…±{{weights.length}}æ¡è®°å½•</text>
    </view>
    <view class="chart-container">
      <canvas canvas-id="weightChart" class="chart-canvas"></canvas>
      <!-- ç®€æ˜“æŠ˜çº¿å›¾å ä½ -->
      <view class="simple-chart">
        <view class="chart-line"></view>
        <block wx:for="{{chartData.series}}" wx:key="index">
          <view class="chart-point" style="left: {{index / (chartData.series.length - 1) * 100}}%; bottom: {{(item - 0) / 10 * 100}}%"></view>
        </block>
      </view>
    </view>
  </view>

  <!-- ä½“é‡è®°å½•åˆ—è¡¨ -->
  <view class="records-section">
    <view class="section-header">
      <text class="section-title">å†å²è®°å½•</text>
      <view class="add-btn-small" bindtap="showAddWeightSheet">
        <text class="add-icon-small">+</text>
        <text>æ·»åŠ </text>
      </view>
    </view>

    <view class="empty-state" wx:if="{{weights.length === 0}}">
      <text class="empty-icon">ğŸ“Š</text>
      <text class="empty-text">è¿˜æ²¡æœ‰ä½“é‡è®°å½•</text>
      <text class="empty-hint">ç‚¹å‡»å³ä¸Šè§’æ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§</text>
    </view>

    <view class="records-list" wx:else>
      <block wx:for="{{weights}}" wx:key="_id">
        <view class="record-item" bindlongpress="deleteWeight" data-id="{{item._id}}">
          <view class="record-date">
            <text class="date-day">{{item.date}}</text>
            <text class="date-time">{{item.createTime}}</text>
          </view>
          <view class="record-content">
            <view class="record-weight">
              <text class="weight-value">{{item.weight}}</text>
              <text class="weight-unit">kg</text>
            </view>
            <text class="record-note" wx:if="{{item.note}}">{{item.note}}</text>
          </view>
        </view>
      </block>
    </view>
  </view>
</view>

<!-- æ·»åŠ ä½“é‡å¼¹çª— -->
<view class="modal {{showAddSheet ? 'show' : ''}}" bindtap="closeAddSheet">
  <view class="modal-content weight-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">æ·»åŠ ä½“é‡è®°å½•</text>
      <text class="modal-close" bindtap="closeAddSheet">âœ•</text>
    </view>

    <view class="modal-body">
      <view class="form-group">
        <text class="label">ä½“é‡ (kg)</text>
        <input class="input large-input" type="digit" placeholder="è¯·è¾“å…¥ä½“é‡" value="{{newWeight.weight}}" bindinput="onWeightInput" />
      </view>

      <view class="form-group">
        <text class="label">æ—¥æœŸ</text>
        <picker mode="date" value="{{newWeight.date}}" bindchange="onDateChange">
          <view class="picker">{{newWeight.date}}</view>
        </picker>
      </view>

      <view class="form-group">
        <text class="label">å¤‡æ³¨</text>
        <textarea class="textarea" placeholder="è®°å½•ä¸€äº›å˜åŒ–..." value="{{newWeight.note}}" bindinput="onNoteInput" maxlength="100"></textarea>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn-primary" bindtap="saveWeight">ä¿å­˜è®°å½•</button>
    </view>
  </view>
</view>

<!-- è®¾ç½®ç›®æ ‡å¼¹çª— -->
<view class="modal {{showTargetSheet ? 'show' : ''}}" bindtap="closeTargetSheet">
  <view class="modal-content target-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">è®¾ç½®ç›®æ ‡ä½“é‡</text>
      <text class="modal-close" bindtap="closeTargetSheet">âœ•</text>
    </view>

    <view class="modal-body">
      <view class="target-tips">
        <text class="tip-icon">ğŸ’¡</text>
        <text class="tip-text">è®¾ç½®ä¸€ä¸ªåˆç†çš„ç›®æ ‡ä½“é‡ï¼Œå¸®åŠ©{{pet.name}}ä¿æŒå¥åº·</text>
      </view>

      <view class="form-group">
        <text class="label">ç›®æ ‡ä½“é‡ (kg)</text>
        <input class="input large-input" type="digit" placeholder="è¯·è¾“å…¥ç›®æ ‡ä½“é‡" value="{{targetWeight}}" bindinput="onTargetInput" />
      </view>

      <view class="target-diff" wx:if="{{targetWeight > 0}}">
        <text class="diff-label">ä¸å½“å‰ä½“é‡ç›¸å·®ï¼š</text>
        <text class="diff-value {{targetDiffClass}}">
          {{targetDiffSign}}{{targetDiffStr}}kg
        </text>
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn-primary" bindtap="saveTarget">ä¿å­˜ç›®æ ‡</button>
    </view>
  </view>
</view>
