<!--pages/index/index.wxml-->
<view class="container">
  
  <!-- é¡¶éƒ¨å® ç‰©å¡ç‰‡ -->
  <view class="card pet-card flex-row" bindtap="switchPet">
    <view class="pet-info flex-row">
      <view class="pet-avatar-wrapper">
        <image class="pet-avatar" src="{{currentPet.avatar || '/images/default_avatar.png'}}" mode="aspectFill"/>
        <view class="gender-icon">
          <text wx:if="{{currentPet.gender == 'female'}}">â™€</text>
          <text wx:else>â™‚</text>
        </view>
      </view>
      <view class="pet-basic flex-col">
        <view class="pet-header flex-row">
          <text class="pet-name">{{currentPet.name}}</text>
          <text class="pet-status">ä»Šå¤© {{logs.length}} æ¡è®°å½•</text>
        </view>
        <text class="pet-desc">{{currentPet.species}} Â· {{currentPet.ageStr || 'æœªçŸ¥å¹´é¾„'}}</text>
      </view>
    </view>
    <view class="switch-btn">
      <text>â‡„</text>
    </view>
  </view>

  <!-- æ—¶é—´è½´ -->
  <view class="timeline">
    <view class="timeline-title">ä»Šæ—¥è¶³è¿¹</view>
    
    <view class="timeline-list">
      <view class="timeline-line"></view>
      
      <block wx:for="{{logs}}" wx:key="_id">
        <view class="log-item">
          <view class="log-dot" style="border-color: {{item.color}}"></view>
          
          <view class="log-card" bindlongpress="deleteLog" data-id="{{item._id}}" data-index="{{index}}">
            <view class="log-header flex-row">
              <text class="log-time">{{item.timeStr}}</text>
              <text class="log-tag" style="background: {{item.color}}20; color: {{item.color}}">
                {{item.typeLabel}}
              </text>
            </view>
            
            <view class="log-content" wx:if="{{item.note}}">
              <text>{{item.note}}</text>
            </view>
            
            <view class="log-images" wx:if="{{item.images && item.images.length > 0}}">
              <image 
                wx:for="{{item.images}}" 
                wx:key="*this"
                wx:for-item="img"
                class="log-img" 
                src="{{img}}" 
                mode="aspectFill"
                catchtap="previewImage"
                data-urls="{{item.images}}"
                data-current="{{img}}"
              />
            </view>
          </view>
        </view>
      </block>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-timeline" wx:if="{{logs.length === 0}}">
        <text style="font-size: 26rpx; color: var(--text-placeholder);">ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•å“¦ï¼Œç‚¹å³ä¸‹è§’æ·»åŠ ~</text>
      </view>
    </view>
  </view>

  <!-- å†å²è¶³è¿¹ -->
  <view class="history-section" wx:if="{{historyLogs.length > 0}}">
    <view class="history-header">
      <text class="history-title">ğŸ“œ å†å²è¶³è¿¹</text>
      <text class="history-subtitle">æœ€è¿‘7å¤©</text>
    </view>

    <view class="history-list">
      <block wx:for="{{historyLogs}}" wx:key="date">
        <view class="history-item">
          <view class="history-date">{{item.dateStr}}</view>
          <view class="history-logs">
            <view class="history-log" wx:for="{{item.logs}}" wx:key="_id" wx:for-item="log">
              <text class="history-emoji" style="background: {{log.color}}20;">{{log.emoji}}</text>
              <text class="history-type">{{log.typeLabel}}</text>
              <text class="history-time">{{log.timeStr}}</text>
            </view>
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- å…¨å±€æ·»åŠ æŒ‰é’® FAB -->
  <view class="fab" bindtap="openLogSheet">
    <text class="fab-icon">+</text>
  </view>

  <!-- åŠ¨æ€æ‰“å¡å¼¹çª— (Bottom Sheet) -->
  <view class="action-sheet-mask {{showActionSheet ? 'show' : ''}}" bindtap="closeLogSheet">
    <view class="action-sheet" catchtap="stopPropagation">
      
      <!-- å¼¹çª—æ ‡é¢˜æ  -->
      <view class="sheet-header">
        <text class="sheet-title" wx:if="{{logStep === 1}}">è®°å½•ä»€ä¹ˆï¼Ÿ</text>
        <view class="flex-row" wx:else bindtap="backToStep1">
          <text style="font-size: 36rpx; margin-right: 10rpx;">â€¹</text>
          <text class="sheet-title">{{currentLog.typeLabel}}</text>
        </view>
        <text class="sheet-close" bindtap="closeLogSheet">âœ•</text>
      </view>
      
      <view class="step-container">
        
        <!-- Step 1: é€‰æ‹©ç±»å‹ -->
        <view class="step-content" wx:if="{{logStep === 1}}">
          <view class="type-grid">
            <view 
              class="type-item" 
              wx:for="{{actionTypes}}" 
              wx:key="type"
              bindtap="selectLogType" 
              data-type="{{item.type}}"
            >
              <view class="type-icon-box">
                <text>{{item.emoji}}</text>
              </view>
              <text class="type-name">{{item.label}}</text>
            </view>
          </view>
        </view>

        <!-- Step 2: å¡«å†™è¯¦æƒ… -->
        <view class="step-content form-content" wx:if="{{logStep === 2}}">
          <view class="form-group">
            <text class="label">æ—¶é—´</text>
            <picker mode="time" value="{{currentLog.time}}" bindchange="onTimeChange">
              <view class="picker">{{currentLog.time}}</view>
            </picker>
          </view>
          
          <view class="form-group">
            <text class="label">å¤‡æ³¨</text>
            <input 
              class="input" 
              placeholder="å†™ç‚¹ä»€ä¹ˆå¤‡æ³¨..." 
              value="{{currentLog.note}}"
              bindinput="onNoteInput"
            />
          </view>

          <view class="form-group">
            <text class="label">ç…§ç‰‡</text>
            <view class="img-list">
              <view 
                class="img-item" 
                wx:for="{{currentLog.images}}" 
                wx:key="*this"
              >
                <image src="{{item}}" mode="aspectFill"/>
                <view class="img-del" catchtap="deleteImage" data-index="{{index}}">âœ•</view>
              </view>
              <view class="img-add" bindtap="chooseImage" wx:if="{{currentLog.images.length < 3}}">
                <text>+</text>
              </view>
            </view>
          </view>

          <button class="btn-primary {{saving?'disabled':''}}" bindtap="saveLog">
            {{saving ? 'ä¿å­˜ä¸­...' : 'ç¡®è®¤æ‰“å¡'}}
          </button>
        </view>

      </view>
    </view>
  </view>

</view>
